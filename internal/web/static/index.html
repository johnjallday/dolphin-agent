<!DOCTYPE html>
<html data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Dark mode overrides (in addition to Bootstrap data-bs-theme) */
    .dark-mode body {
      background-color: #121212 !important;
      color: #e4e4e4;
    }
    .dark-mode #chatArea {
      background-color: #1e1e1e !important;
      border-color: #333 !important;
    }
    .dark-mode .bg-light {
      background-color: #2c2c2c !important;
      color: #e4e4e4 !important;
    }
    .dark-mode .bg-white {
      background-color: #1e1e1e !important;
      color: #e4e4e4 !important;
    }
    .dark-mode .text-dark {
      color: #e4e4e4 !important;
    }
    .dark-mode .border {
      border-color: #333 !important;
    }
    .dark-mode .bg-primary {
      background-color: #4e8ef7 !important;
    }
  </style>
</head>

<body class="bg-light">
  <!-- Top Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <button class="btn btn-outline-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">Chatbot</a>
      <button id="darkModeToggle" class="btn btn-outline-light ms-auto">ðŸŒ™ Dark Mode</button>
    </div>
  </nav>

  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel">Controls</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Tabs -->
      <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pills-agents-tab" data-bs-toggle="pill" data-bs-target="#pills-agents" type="button" role="tab">Agents</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pills-plugins-tab" data-bs-toggle="pill" data-bs-target="#pills-plugins" type="button" role="tab">Plugins</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pills-settings-tab" data-bs-toggle="pill" data-bs-target="#pills-settings" type="button" role="tab">Settings</button>
        </li>
      </ul>
      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-agents" role="tabpanel">
          <div class="input-group mb-2">
            <input type="text" id="agentName" class="form-control" placeholder="Agent name" />
            <button id="createAgent" class="btn btn-success">New</button>
          </div>
          <ul id="agentsList" class="list-group"></ul>
        </div>
        <div class="tab-pane fade" id="pills-plugins" role="tabpanel">
          <div id="registryList" class="list-group mb-2"></div>
          <div class="input-group mb-2">
            <input type="file" id="pluginfile" class="form-control" accept=".so" />
            <button id="loadBtn" class="btn btn-success">Load</button>
          </div>
          <ul id="plugins" class="list-group"></ul>
        </div>
        <div class="tab-pane fade" id="pills-settings" role="tabpanel">
          <div class="mb-2">
            <label class="form-label">Model:</label>
            <select id="modelSelect" class="form-select">
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4.1">GPT-4.1</option>
              <option value="gpt-4.1-turbo">GPT-4.1 Turbo</option>
              <option value="gpt-5">GPT-5</option>
              <option value="gpt-5-turbo">GPT-5 Turbo</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Temperature:</label>
            <input type="number" id="tempInput" class="form-control" step="0.1" min="0" max="2" />
          </div>
          <button id="saveSettings" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="container-fluid p-3" id="mainContent">
    <div id="chatArea" class="overflow-auto p-3 mb-2 bg-white border rounded" style="height:75vh;"></div>

    <div class="mb-2">
      <div class="input-group">
        <textarea id="input" class="form-control" rows="2" placeholder="Type your message... (Enter to send, Shift+Enter for newline)"></textarea>
        <button id="sendBtn" class="btn btn-primary">Send</button>
      </div>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="enterToSend" checked>
        <label class="form-check-label" for="enterToSend">Press Enter to send</label>
      </div>
    </div>
  </div>

  <!-- Scripts (load Bootstrap once, then your app JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentAgent = '';
    let isComposing = false; // IME safety

    // ---- Dark Mode (Bootstrap + custom) ----
    function applyTheme(isDark) {
      // Bootstrap theming
      document.documentElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
      // Your extra overrides
      document.documentElement.classList.toggle('dark-mode', isDark);
      // Persist
      localStorage.setItem('darkMode', String(isDark));
    }

    // Init theme from storage (default light)
    const storedDark = localStorage.getItem('darkMode') === 'true';
    applyTheme(storedDark);

    // Toggle button
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      const next = !(localStorage.getItem('darkMode') === 'true');
      applyTheme(next);
    });

    // ---- Agents ----
    async function refreshAgents() {
      const res = await fetch('/api/agents');
      const data = await res.json();
      currentAgent = data.current;
      const ul = document.getElementById('agentsList');
      ul.innerHTML = '';
      data.agents.forEach(a => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = a;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm ' + (a === currentAgent ? 'btn-secondary' : 'btn-outline-primary');
        btn.textContent = a === currentAgent ? 'Current' : 'Switch';
        btn.disabled = a === currentAgent;
        btn.onclick = async () => { await fetch('/api/agents?name=' + a, { method: 'PUT' }); await init(); };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    document.getElementById('createAgent').onclick = async () => {
      const name = document.getElementById('agentName').value;
      if (!name) return alert('Enter agent name');
      await fetch('/api/agents', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name}) });
      document.getElementById('agentName').value = '';
      await init();
    };

    // ---- Plugins ----
    async function refreshPlugins() {
      const res = await fetch('/api/plugins');
      const data = await res.json();
      const ul = document.getElementById('plugins');
      ul.innerHTML = '';
      data.plugins.forEach(p => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const info = document.createElement('div');
        info.innerHTML = '<strong>' + p.name + '</strong>: ' + p.description;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-danger';
        btn.textContent = 'Unload';
        btn.onclick = async () => {
          await fetch('/api/plugins?name=' + encodeURIComponent(p.name), { method: 'DELETE' });
          await refreshPlugins();
        };
        li.appendChild(info);
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    // Registry of available plugins
    async function refreshRegistry() {
      const res = await fetch('/api/plugin-registry');
      const data = await res.json();
      const container = document.getElementById('registryList');
      container.innerHTML = '';
      data.plugins.forEach(p => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        const info = document.createElement('div');
        info.innerHTML = '<strong>' + p.name + '</strong>: ' + p.description;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-success';
        btn.textContent = 'Load';
        btn.onclick = async () => {
          await fetch('/api/plugin-registry', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ name: p.name }),
          });
          await refreshPlugins();
          await refreshRegistry();
        };
        item.appendChild(info);
        item.appendChild(btn);
        container.appendChild(item);
      });
    }

    document.getElementById('loadBtn').onclick = async () => {
      const fileInput = document.getElementById('pluginfile');
      if (fileInput.files.length === 0) return alert('Select a plugin .so file');
      const form = new FormData();
      form.append('plugin', fileInput.files[0]);
      await fetch('/api/plugins', { method: 'POST', body: form });
      await refreshPlugins();
    };

    // ---- Chat ----
    document.getElementById('sendBtn').onclick = async () => {
      const input = document.getElementById('input');
      const q = input.value.trim();
      if (!q) return;
      addChat('User', q);
      input.value = '';
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: q }),
      });
      const data = await res.json();
      if (data.toolCall) {
        addChat(data.toolCall.function, data.toolCall.result);
      }
      addChat('Assistant', data.response);
      input.focus();
    };

    // Enter-to-send + IME-safe handling
    (function setupEnterBehavior(){
      const input = document.getElementById('input');
      const enterToggle = document.getElementById('enterToSend');

      input.addEventListener('compositionstart', () => { isComposing = true; });
      input.addEventListener('compositionend', () => { isComposing = false; });

      input.addEventListener('keydown', (e) => {
        const cmdOrCtrl = e.ctrlKey || e.metaKey;
        if ((cmdOrCtrl && e.key === 'Enter') && !isComposing) {
          e.preventDefault();
          document.getElementById('sendBtn').click();
          return;
        }
        if (enterToggle.checked && e.key === 'Enter' && !e.shiftKey && !isComposing) {
          e.preventDefault();
          document.getElementById('sendBtn').click();
        }
      });
    })();

    function addChat(who, text) {
      const chatArea = document.getElementById('chatArea');
      const row = document.createElement('div');
      row.className = 'd-flex mb-2 ' + (who === 'User' ? 'justify-content-end' : 'justify-content-start');

      const bubble = document.createElement('div');
      bubble.className = 'p-2 rounded ' + (who === 'User' ? 'bg-primary text-white' : 'bg-light text-dark');

      const strong = document.createElement('strong');
      strong.textContent = who + ': ';
      const span = document.createElement('span');
      span.textContent = text;

      bubble.appendChild(strong);
      bubble.appendChild(span);
      row.appendChild(bubble);
      chatArea.appendChild(row);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function init() {
      await refreshAgents();
      await refreshPlugins();
      await refreshRegistry();
      const res = await fetch('/api/settings');
      const s = await res.json();
      document.getElementById('modelSelect').value = s.model;
      document.getElementById('tempInput').value = s.temperature;
    }

    window.onload = init;
  </script>
</body>
</html>
